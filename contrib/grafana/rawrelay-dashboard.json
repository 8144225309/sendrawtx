{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "Prometheus data source for RawRelay metrics",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus" },
    { "type": "panel", "id": "timeseries", "name": "Time series" },
    { "type": "panel", "id": "stat", "name": "Stat" },
    { "type": "panel", "id": "gauge", "name": "Gauge" },
    { "type": "panel", "id": "bargauge", "name": "Bar gauge" },
    { "type": "panel", "id": "heatmap", "name": "Heatmap" },
    { "type": "panel", "id": "table", "name": "Table" }
  ],
  "id": null,
  "uid": "rawrelay-overview",
  "title": "RawRelay",
  "description": "Bitcoin transaction relay server monitoring",
  "tags": ["rawrelay", "bitcoin"],
  "timezone": "browser",
  "editable": true,
  "graphTooltip": 1,
  "refresh": "10s",
  "schemaVersion": 39,
  "version": 1,
  "time": { "from": "now-1h", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "query": "prometheus",
        "current": {},
        "hide": 0
      },
      {
        "name": "instance",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${datasource}" },
        "query": "label_values(rawrelay_requests_total, instance)",
        "refresh": 2,
        "includeAll": true,
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" }
      },
      {
        "name": "worker",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${datasource}" },
        "query": "label_values(rawrelay_requests_total{instance=~\"$instance\"}, worker)",
        "refresh": 2,
        "includeAll": true,
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" }
      }
    ]
  },
  "panels": [

    {
      "title": "",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "collapsed": false,
      "panels": []
    },

    {
      "title": "Request Rate",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
      "targets": [
        { "expr": "sum(rate(rawrelay_requests_total{instance=~\"$instance\", worker=~\"$worker\"}[5m]))", "legendFormat": "" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 500 }, { "color": "red", "value": 1000 }] }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "area" }
    },

    {
      "title": "Active Connections",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
      "targets": [
        { "expr": "sum(rawrelay_active_connections{instance=~\"$instance\", worker=~\"$worker\"})", "legendFormat": "" }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 100 }, { "color": "red", "value": 400 }] }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "area" }
    },

    {
      "title": "Error Rate (5xx)",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 },
      "targets": [
        { "expr": "sum(rate(rawrelay_http_requests_by_class_total{instance=~\"$instance\", worker=~\"$worker\", class=\"5xx\"}[5m]))", "legendFormat": "" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 10 }] }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "area" }
    },

    {
      "title": "TLS Cert Expiry",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 },
      "targets": [
        { "expr": "min((rawrelay_tls_cert_expiry_timestamp_seconds{instance=~\"$instance\", worker=~\"$worker\"} - time()) / 86400)", "legendFormat": "" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "d",
          "decimals": 0,
          "thresholds": { "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 7 }, { "color": "green", "value": 30 }] }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "none" }
    },

    {
      "title": "Uptime",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 1 },
      "targets": [
        { "expr": "max(rawrelay_process_uptime_seconds{instance=~\"$instance\", worker=~\"$worker\"})", "legendFormat": "" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "thresholds": { "steps": [{ "color": "green", "value": null }] }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "none", "graphMode": "none" }
    },

    {
      "title": "Rejections/s",
      "type": "stat",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 1 },
      "targets": [
        { "expr": "sum(rate(rawrelay_connections_rejected_total{instance=~\"$instance\", worker=~\"$worker\"}[5m]))", "legendFormat": "" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 5 }, { "color": "red", "value": 50 }] }
        }
      },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background", "graphMode": "area" }
    },

    {
      "title": "Traffic",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
      "collapsed": false,
      "panels": []
    },

    {
      "title": "Request Rate by Worker",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 6 },
      "targets": [
        { "expr": "rate(rawrelay_requests_total{instance=~\"$instance\", worker=~\"$worker\"}[1m])", "legendFormat": "worker {{worker}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "fillOpacity": 20, "stacking": { "mode": "normal" } }
        }
      }
    },

    {
      "title": "HTTP Status Codes",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 6 },
      "targets": [
        { "expr": "sum by (status) (rate(rawrelay_http_requests_total{instance=~\"$instance\", worker=~\"$worker\"}[1m]))", "legendFormat": "{{status}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "fillOpacity": 20, "stacking": { "mode": "normal" } }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "200" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "400" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "404" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "408" }, "properties": [{ "id": "color", "value": { "fixedColor": "purple", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "429" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "503" }, "properties": [{ "id": "color", "value": { "fixedColor": "dark-red", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "title": "Request Latency (P50 / P90 / P99)",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 14 },
      "targets": [
        { "expr": "histogram_quantile(0.50, sum by (le) (rate(rawrelay_request_duration_seconds_bucket{instance=~\"$instance\", worker=~\"$worker\"}[5m])))", "legendFormat": "p50" },
        { "expr": "histogram_quantile(0.90, sum by (le) (rate(rawrelay_request_duration_seconds_bucket{instance=~\"$instance\", worker=~\"$worker\"}[5m])))", "legendFormat": "p90" },
        { "expr": "histogram_quantile(0.99, sum by (le) (rate(rawrelay_request_duration_seconds_bucket{instance=~\"$instance\", worker=~\"$worker\"}[5m])))", "legendFormat": "p99" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": { "fillOpacity": 10 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "p50" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "p90" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "p99" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "title": "Latency Heatmap",
      "type": "heatmap",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 14 },
      "targets": [
        { "expr": "sum(increase(rawrelay_request_duration_seconds_bucket{instance=~\"$instance\", worker=~\"$worker\"}[$__rate_interval])) by (le)", "legendFormat": "{{le}}", "format": "heatmap" }
      ],
      "options": {
        "calculate": false,
        "yAxis": { "unit": "s" },
        "color": { "scheme": "Oranges", "mode": "scheme" },
        "cellGap": 1
      }
    },

    {
      "title": "Connections",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 22 },
      "collapsed": false,
      "panels": []
    },

    {
      "title": "Active Connections by Worker",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 23 },
      "targets": [
        { "expr": "rawrelay_active_connections{instance=~\"$instance\", worker=~\"$worker\"}", "legendFormat": "worker {{worker}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "fillOpacity": 20, "stacking": { "mode": "normal" } }
        }
      }
    },

    {
      "title": "Rejections by Reason",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 23 },
      "targets": [
        { "expr": "sum by (reason) (rate(rawrelay_connections_rejected_total{instance=~\"$instance\", worker=~\"$worker\"}[1m]))", "legendFormat": "{{reason}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "fillOpacity": 20 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "rate_limit" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "slot_limit" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "blocked" }, "properties": [{ "id": "color", "value": { "fixedColor": "purple", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "title": "Slot Usage by Tier",
      "type": "bargauge",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 23 },
      "targets": [
        { "expr": "sum by (tier) (rawrelay_slots_used{instance=~\"$instance\", worker=~\"$worker\"}) / sum by (tier) (rawrelay_slots_max{instance=~\"$instance\", worker=~\"$worker\"})", "legendFormat": "{{tier}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "min": 0,
          "max": 1,
          "thresholds": { "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 0.7 }, { "color": "red", "value": 0.9 }] }
        }
      },
      "options": { "orientation": "horizontal", "displayMode": "gradient", "reduceOptions": { "calcs": ["lastNotNull"] } }
    },

    {
      "title": "TLS & HTTP/2",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 31 },
      "collapsed": false,
      "panels": []
    },

    {
      "title": "TLS Handshakes by Version",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 32 },
      "targets": [
        { "expr": "sum by (protocol) (rate(rawrelay_tls_handshakes_total{instance=~\"$instance\", worker=~\"$worker\"}[1m]))", "legendFormat": "{{protocol}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "fillOpacity": 20 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "TLSv1.3" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "TLSv1.2" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "title": "TLS Errors",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 32 },
      "targets": [
        { "expr": "sum(rate(rawrelay_tls_handshake_errors_total{instance=~\"$instance\", worker=~\"$worker\"}[1m]))", "legendFormat": "handshake errors" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "fillOpacity": 20 },
          "color": { "fixedColor": "red", "mode": "fixed" }
        }
      }
    },

    {
      "title": "HTTP/2 Streams",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 32 },
      "targets": [
        { "expr": "sum(rawrelay_http2_streams_active{instance=~\"$instance\", worker=~\"$worker\"})", "legendFormat": "active streams" },
        { "expr": "sum(rate(rawrelay_http2_streams_total{instance=~\"$instance\", worker=~\"$worker\"}[1m]))", "legendFormat": "new streams/s" },
        { "expr": "sum(rate(rawrelay_http2_rst_stream_total{instance=~\"$instance\", worker=~\"$worker\"}[1m]))", "legendFormat": "RST_STREAM/s" },
        { "expr": "sum(rate(rawrelay_http2_goaway_total{instance=~\"$instance\", worker=~\"$worker\"}[1m]))", "legendFormat": "GOAWAY/s" }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "fillOpacity": 10 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "RST_STREAM/s" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "GOAWAY/s" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "title": "Resources",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 40 },
      "collapsed": false,
      "panels": []
    },

    {
      "title": "File Descriptors",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 41 },
      "targets": [
        { "expr": "sum(rawrelay_open_fds{instance=~\"$instance\", worker=~\"$worker\"})", "legendFormat": "open" },
        { "expr": "sum(rawrelay_max_fds{instance=~\"$instance\", worker=~\"$worker\"})", "legendFormat": "max" }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "fillOpacity": 10 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "max" }, "properties": [{ "id": "custom.lineStyle", "value": { "fill": "dash", "dash": [10, 10] } }, { "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "open" }, "properties": [{ "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }] }
        ]
      }
    },

    {
      "title": "Rate Limiter Table Size",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 41 },
      "targets": [
        { "expr": "rawrelay_rate_limiter_entries{instance=~\"$instance\", worker=~\"$worker\"}", "legendFormat": "worker {{worker}}" }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "fillOpacity": 20 }
        }
      }
    },

    {
      "title": "Errors by Type",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 41 },
      "targets": [
        { "expr": "sum(rate(rawrelay_errors_total{instance=~\"$instance\", worker=~\"$worker\", type=\"timeout\"}[1m]))", "legendFormat": "timeout" },
        { "expr": "sum(rate(rawrelay_errors_total{instance=~\"$instance\", worker=~\"$worker\", type=\"parse_error\"}[1m]))", "legendFormat": "parse error" },
        { "expr": "sum(rate(rawrelay_errors_total{instance=~\"$instance\", worker=~\"$worker\", type=\"tls_error\"}[1m]))", "legendFormat": "TLS error" }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "fillOpacity": 20 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "timeout" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "parse error" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "TLS error" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }
        ]
      }
    }
  ]
}
