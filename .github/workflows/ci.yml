name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, macos-14, macos-15]
        compiler: [gcc, clang]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config \
            libevent-dev libssl-dev libnghttp2-dev

      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install libevent openssl nghttp2 pkg-config

      - name: Build with ${{ matrix.compiler }}
        env:
          CC: ${{ matrix.compiler }}
        run: make

      - name: Run unit tests
        run: make test

      - name: Functional tests
        run: |
          echo "Starting server..."
          ./rawrelay-server -c config.ini.example -w 1 &
          SERVER_PID=$!
          sleep 2

          echo "Test 1: Health endpoint"
          curl -sf http://localhost:8080/health | head -c 100
          echo ""

          echo "Test 2: 64-char hex path (txid format)"
          TXID="0000000000000000000000000000000000000000000000000000000000000000"
          STATUS=$(curl -sf -o /dev/null -w "%{http_code}" "http://localhost:8080/${TXID}")
          if [ "$STATUS" != "200" ]; then
            echo "FAIL: Expected 200, got $STATUS"
            exit 1
          fi
          echo "OK: $STATUS"

          echo "Test 3: 200-char hex path"
          HEX200=$(printf '0%.0s' {1..200})
          STATUS=$(curl -sf -o /dev/null -w "%{http_code}" "http://localhost:8080/${HEX200}")
          if [ "$STATUS" != "200" ]; then
            echo "FAIL: Expected 200, got $STATUS"
            exit 1
          fi
          echo "OK: $STATUS"

          echo "Test 4: Invalid path (should return error page)"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/invalid!path")
          echo "Got: $STATUS (error page expected)"

          echo "Stopping server..."
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true

          echo "All functional tests passed!"

  # Memory safety with AddressSanitizer and UndefinedBehaviorSanitizer
  sanitizers:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config \
            libevent-dev libssl-dev libnghttp2-dev

      - name: Build with ASan/UBSan
        run: |
          make clean
          make CFLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g -O1 -Wall -Wextra -Werror -I./include -D_GNU_SOURCE"

      - name: Run with sanitizers
        run: |
          echo "Starting server with sanitizers..."
          ./rawrelay-server -c config.ini.example -w 1 &
          SERVER_PID=$!
          sleep 2

          echo "Running requests to trigger sanitizer checks..."
          for i in {1..20}; do
            curl -sf http://localhost:8080/health > /dev/null
            curl -sf "http://localhost:8080/0000000000000000000000000000000000000000000000000000000000000000" > /dev/null
          done

          echo "Testing large URL..."
          HEX1000=$(printf 'a%.0s' {1..1000})
          curl -sf "http://localhost:8080/${HEX1000}" > /dev/null

          echo "Stopping server..."
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true

          echo "Sanitizer tests passed - no memory errors detected!"

  # Static analysis with cppcheck
  static-analysis:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance,portability \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=knownConditionTrueFalse \
            --suppress=constVariablePointer \
            --suppress=constParameterPointer \
            --suppress=variableScope \
            --inline-suppr \
            -I include/ \
            src/ include/
